# Kotlin Multiplatform (with `expect` modality)

This module contains the common code and use the `expect` modality of KtorGen to generate accessors.

This feature is **experimental** and can break builds.

## Usage

```kotlin
@OptIn(KtorGenExperimental::class)
@KtorGenFunctionKmp
expect fun ApiServiceValid(httpClient: HttpClient): ApiServiceValid

@KtorGen
interface ApiServiceValid {...}
```

KtorGen will generate the accessors for all platform source set according to the `expect` modality.
Is **required** to `expect` function have a valid interface as return type knowed by KtorGen, the exact parameters of
the constructor, and the `HttpClient` parameter (if you don't have it already as property).

The exact parameters include the delegate interfaces when you have inheritance. See DemoGithub interface, for example.

### Known limitations

- Only top-level factory functions are supported.

- All actual accessors are generated by KtorGen in the same file as the implementation class.

- If you have a `expect` function, factory top level function and custom name for the generated class, KtorGen will
generate all and clash declaration between `expect` function and top level function, going to fail the build.

```kotlin
@OptIn(KtorGenExperimental::class)
@KtorGenFunctionKmp
expect fun OtherName(httpClient: HttpClient): OtherName

@KtorGen(
    "MyName",
    generateTopLevelFunction = false, // conflict overload
)
interface OtherName
```

Workaround:
- Define another name for the `expect function`
- Disable top level function generation with `generateTopLevelFunction = false` in `@KtorGen`
- Don't use `@KtorGenFunctionKmp` on the `expect function` and create the accessors manually

The root of the issue is that KtorGen doesn't validate expect function signature before generating the accessors and
expect signature is strictly checked by the compiler. Another solution would be to generate accessors with the same name
of the class, but it's too late for that.

This limitation will be removed in the future with better handling of the `expect` modality.

## Configuration

As you can see in the `gradle.properties` file, until https://github.com/google/ksp/issues/2267 is fixed, needs:
`kotlin.native.enableKlibsCrossCompilation=false` if you have `kotlin.native.incremental=true`

As you can see in the `build.gradle` file, all targets need the corresponding ksp processor dependency:
```kotlin
kotlin {
  applyDefaultHierarchyTemplate()
  androidLibrary { ... }
  jvm()
  js { ... }
  wasmJs { ... }
  iosArm64()
  iosX64()
  iosSimulatorArm64()
  macosX64()
  macosArm64()
  watchosArm32()
  watchosArm64()
  watchosX64()
  watchosSimulatorArm64()
  tvosArm64()
  tvosX64()
  tvosSimulatorArm64()
  linuxX64()
  linuxArm64()
  androidNativeArm32()
  androidNativeArm64()
  androidNativeX86()
  androidNativeX64()
  mingwX64()
  watchosDeviceArm64()

  sourceSets.commonMain.dependencies {
    implementation(libs.ktorgen.annotations)
    implementation(libs.ktor.client.core)
  }
}

dependencies {
  // ksp(projects.compiler)
  // KMP project don't use this, only jvm or android kotlin projects

  // don't apply on common main because we're going to generate on each platform. STILL FAILING
  // In recent versions of KSP are no longer available commonMainMetadata configuration
  // kspCommonMainMetadata(libs.ktorgen.compiler)

  add("kspAndroid", libs.ktorgen.compiler)
  add("kspJvm", libs.ktorgen.compiler)
  add("kspJs", libs.ktorgen.compiler)
  add("kspWasmJs", libs.ktorgen.compiler)
  add("kspAndroidNativeX64", libs.ktorgen.compiler)
  add("kspAndroidNativeX86", libs.ktorgen.compiler)
  add("kspAndroidNativeArm32", libs.ktorgen.compiler)
  add("kspAndroidNativeArm64", libs.ktorgen.compiler)
  add("kspLinuxX64", libs.ktorgen.compiler)
  add("kspLinuxArm64", libs.ktorgen.compiler)
  add("kspMingwX64", libs.ktorgen.compiler)
  add("kspIosX64", libs.ktorgen.compiler)
  add("kspIosArm64", libs.ktorgen.compiler)
  add("kspIosSimulatorArm64", libs.ktorgen.compiler)
  add("kspTvosArm64", libs.ktorgen.compiler)
  add("kspMacosArm64", libs.ktorgen.compiler)
  add("kspMacosX64", libs.ktorgen.compiler)
}
```
